<!DOCTYPE html>
<html>
<head>
  <title>AirBridge - Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
      background-size: 400% 400%;
      animation: gradientBG 10s ease infinite;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      -webkit-tap-highlight-color: transparent;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .container::before, .container::after {
      content: "";
      position: absolute;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      filter: blur(10px);
      animation: floatParticles 5s infinite alternate ease-in-out;
    }

    .container::before {
      top: -10px;
      left: 10px;
    }

    .container::after {
      bottom: -10px;
      right: 10px;
    }

    @keyframes floatParticles {
      0% { transform: translateY(0px); opacity: 0.8; }
      100% { transform: translateY(15px); opacity: 0.5; }
    }

    .split-view {
      display: flex;
      gap: 1rem;
      flex: 1;
      min-height: 0;
      position: relative;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .broadcast-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      height: calc(100vh - 250px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #888 #f1f1f1;
    }
    .broadcast-section::-webkit-scrollbar {
      width: 6px;
    }
    .broadcast-section::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .broadcast-section::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    .broadcast-section::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      border-left: 1px solid #e9ecef;
      height: calc(100vh - 250px);
      overflow: hidden;
    }
    .chat-section.hidden {
      display: none;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #888 #f1f1f1;
      position: relative;
      height: calc(100% - 120px); /* Account for header and input container */
    }
    .messages-container::-webkit-scrollbar {
      width: 6px;
    }
    .messages-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .messages-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    .messages-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    .chat-input-container {
      padding: 1rem;
      background: #f0f2f5;
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      border-top: 1px solid #e9ecef;
    }
    .chat-toggle {
      background: #2ecc71;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      color: white;
    }
    .chat-toggle:hover {
      background: #27ae60;
    }
    .chat-toggle .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      min-width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      padding: 0 8px;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .chat-toggle .badge.show {
      display: flex;
    }
    .chat-toggle::before {
      content: 'ðŸ’¬';
      font-size: 1.2em;
    }
    .chat-toggle.active {
      background: #27ae60;
    }
    .chat-toggle.active::before {
      content: 'âœ•';
    }
    #room-info {
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .room-info-left {
      flex: 1;
      min-width: 200px;
    }
    .room-info-right {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      width: 100%;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 0.5rem 0;
    }
    #room-info h2 {
      margin: 0;
      font-size: 1.4rem;
      color: #2c3e50;
    }
    #text-input {
      width: 100%;
      flex: 1;
      padding: 1.5rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      resize: none;
      font-size: 16px;
      line-height: 1.6;
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    #text-input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    button {
      padding: 12px 24px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
    }
    button:hover {
      background: #2980b9;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #copy-button {
      background: #2ecc71;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }
    #copy-button:hover {
      background: #27ae60;
    }
    #copy-button:active {
      background: #219a52;
    }
    #copy-button::before {
      content: 'ðŸ“‹';
      font-size: 1.2em;
    }
    #copy-button.copied {
      background: #27ae60;
      animation: copySuccess 0.3s ease;
    }
    @keyframes copySuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #user-count {
      color: #666;
      font-size: 1rem;
      margin: 0.5rem 0;
      padding: 0.5rem 1rem;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-20px);
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification.success {
      background: #2ecc71;
    }
    .notification.error {
      background: #e74c3c;
    }
    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      left: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      display: none;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      transform: translateY(20px);
    }
    #connection-status.show {
      transform: translateY(0);
    }
    #connection-status.connected {
      background: #2ecc71;
      color: white;
    }
    #connection-status.disconnected {
      background: #e74c3c;
      color: white;
    }
    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
      #room-info {
        padding: 0.8rem;
      }
      #text-input {
        font-size: 16px;
        padding: 1rem;
      }
      button {
        padding: 10px 20px;
        font-size: 0.95rem;
      }
      #copy-button {
        min-width: 140px;
      }
      #connection-status {
        bottom: 10px;
        right: 10px;
        left: 10px;
        padding: 10px 15px;
      }
      .room-info-right {
        margin-top: 1rem;
        width: 100%;
      }
      .file-upload-container {
        gap: 0.5rem;
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
      .file-upload-btn, .chat-toggle, #copy-button {
        width: 100%;
      font-size: 0.9rem;
        padding: 10px 12px;
        min-width: unset;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .file-input-wrapper {
        width: 100%;
        height: 44px;
      }
      .file-input-wrapper input[type=file] {
        width: 100%;
        height: 100%;
      }
      .split-view {
        flex-direction: column;
        min-height: 800px;
      }
      .chat-section {
        border-left: none;
        border-top: 1px solid #e9ecef;
        min-height: 400px;
      }
      .broadcast-section {
        min-height: 400px;
      }
      .messages-container {
        padding: 0.75rem;
      }
    }
    @media (max-width: 768px) {
      .split-view {
        flex-direction: column;
      }
      .chat-section {
        border-left: none;
        border-top: 1px solid #e9ecef;
        height: 600px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .broadcast-section {
        height: 600px;
      }
      .messages-container {
        height: calc(100% - 100px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
        overscroll-behavior: contain;
      }
      .chat-input-container {
        position: sticky;
        bottom: 0;
        background: #f0f2f5;
        z-index: 10;
      }
      .room-controls {
        flex-direction: column;
        gap: 8px;
      }

      .room-controls button {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        min-width: unset;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #copy-button {
        order: 1;
        min-width: 100%;
        white-space: normal;
        text-align: center;
        padding: 12px 16px;
      }

      #nickname-button {
        order: 2;
        min-width: 100%;
        white-space: normal;
        text-align: center;
        padding: 12px 16px;
      }

      .file-upload-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .file-upload-btn, .chat-toggle {
        width: 100%;
        min-width: unset;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-input-wrapper {
        width: 100%;
        height: 44px;
      }

      .file-input-wrapper input[type=file] {
        width: 100%;
        height: 100%;
      }
    }
    .file-upload-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
      background: white;
      padding: 0.5rem 0;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      flex: 1;
      min-width: 120px;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
      height: 100%;
      width: 100%;
      z-index: 2;
    }
    .file-upload-btn, .chat-toggle, #copy-button {
      flex: 1;
      min-width: 120px;
      white-space: nowrap;
      text-align: center;
      padding: 12px 16px;
      font-size: 0.95rem;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .file-upload-btn::before {
      content: 'ðŸ“Ž';
      font-size: 1.2em;
    }
    .file-upload-btn:hover {
      background: #2980b9;
    }
    .file-upload-btn:active {
      background: #2472a4;
    }
    .file-list {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: none;
    }
    .file-list.visible {
      display: block;
    }
    .broadcast-header, .chat-header {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 2px solid #e9ecef;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      transition: background-color 0.2s ease;
    }
    .file-item:hover {
      background: #f0f2f5;
    }
    .file-icon {
      font-size: 1.5em;
    }
    .file-info {
      flex: 1;
    }
    .file-name {
      font-weight: 500;
      color: #2c3e50;
    }
    .file-size {
      font-size: 0.9em;
      color: #666;
    }
    .file-download {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }
    .file-download:hover {
      text-decoration: underline;
    }
    .connected-users {
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 0.5rem;
    }
    .connected-users h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
      color: #666;
    }
    .user-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .user-item {
      background: #e9ecef;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.85rem;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .user-item::before {
      content: 'ðŸ‘¤';
      font-size: 0.9em;
    }
    .join-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-20px);
    }
    .join-notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .join-notification.join {
      background: #2ecc71;
    }
    .join-notification.leave {
      background: #e74c3c;
    }
    .message {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      margin: 0.5rem 0;
      display: flex;
      flex-direction: column;
      align-self: flex-start;
    }
    .message.sent {
      background: #dcf8c6;
      color: #000;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    .message.received {
      background: #fff;
      color: #000;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-right: auto;
    }
    .message.system {
      background: #f0f2f5;
      color: #65676b;
      align-self: center;
      text-align: center;
      max-width: 90%;
      font-size: 0.9em;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin: 0.5rem auto;
      box-shadow: none;
    }
    .message .username {
      font-weight: bold;
      margin-bottom: 0.25rem;
      font-size: 0.85em;
      color: #128c7e;
    }
    .message .text {
      font-size: 0.95em;
      line-height: 1.4;
    }
    .chat-input {
      flex: 1;
      min-height: 40px;
      max-height: 120px;
      padding: 0.75rem;
      border: none;
      border-radius: 20px;
      background: white;
      font-size: 1rem;
      line-height: 1.4;
      resize: none;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .chat-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #128c7e;
    }
    .send-button {
      background: #128c7e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .send-button:hover {
      background: #075e54;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .send-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .send-button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .send-button::before {
      display: none;
    }
    .nickname-button {
      background: #9b59b6;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
    }
    .nickname-button::before {
      content: 'ðŸ‘¤';
      font-size: 1.2em;
    }
    .nickname-button:hover {
      background: #8e44ad;
    }
    .nickname-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .nickname-modal.show {
      display: flex;
    }
    .nickname-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 90%;
      max-width: 400px;
    }
    .nickname-content h3 {
      margin: 0 0 1rem 0;
      color: #2c3e50;
    }
    .nickname-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .nickname-form input {
      padding: 0.75rem;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 1rem;
    }
    .nickname-form input:focus {
      outline: none;
      border-color: #9b59b6;
    }
    .nickname-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .nickname-buttons button {
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
    }
    .nickname-buttons button[type="button"] {
      background: #e9ecef;
      color: #2c3e50;
    }
    .nickname-buttons button[type="button"]:hover {
      background: #dee2e6;
    }
    .room-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .room-controls button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      min-width: 120px;
      justify-content: center;
    }

    .room-controls button:hover {
      background-color: #0056b3;
    }

    .room-controls button:active {
      transform: scale(0.98);
    }

    .room-controls button.copied {
      background-color: #28a745;
    }

    .room-controls button i {
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .messages-container {
        height: calc(100% - 100px); /* Slightly smaller on mobile */
        -webkit-overflow-scrolling: touch;
        overflow-y: scroll;
        position: relative;
        overscroll-behavior: contain;
      }
      .chat-section {
        height: 600px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-input-container {
        position: sticky;
        bottom: 0;
        background: #f0f2f5;
        z-index: 10;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading-overlay">
      <div class="spinner"></div>
    </div>
    <div id="room-info">
      <div class="room-info-left">
        <h2>Room: <span id="room-id"></span></h2>
        <div id="user-count">Users connected: <span>1</span></div>
      </div>
      <div class="room-info-right">
        <div class="file-upload-container">
          <div class="file-input-wrapper">
            <button class="file-upload-btn" id="upload-btn">
              Upload File
            </button>
            <input type="file" id="file-input" accept="image/*,.pdf,.txt" style="display: none">
    </div>
          <button class="chat-toggle" id="chat-toggle">Chat</button>
          <button id="copy-button" onclick="copyRoomLink()">Copy Room Link</button>
          <button class="nickname-button" id="nickname-button">Change Nickname</button>
        </div>
      </div>
    </div>
    <div class="split-view">
      <div class="broadcast-section">
        <div class="file-list" id="file-list">
          <h3>Shared Files</h3>
          <div id="files-container"></div>
        </div>
        <div class="broadcast-header">Broadcast</div>
        <textarea id="text-input" placeholder="Broadcast your message..." disabled></textarea>
      </div>
      <div class="chat-section hidden" id="chat-section">
        <div class="chat-header">Chat</div>
        <div class="messages-container" id="messages-container"></div>
        <div class="chat-input-container">
          <textarea class="chat-input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
          <button class="send-button" id="send-button" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>
  <div id="notification" class="notification"></div>
  <div id="join-notification" class="join-notification"></div>
  <div id="connection-status">Connection Status</div>

  <div class="nickname-modal" id="nickname-modal">
    <div class="nickname-content">
      <h3>Change Nickname</h3>
      <form class="nickname-form" id="nickname-form">
        <input type="text" id="nickname-input" placeholder="Enter new nickname" maxlength="20">
        <div class="nickname-buttons">
          <button type="submit">Save</button>
          <button type="button" onclick="hideNicknameModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({
      transports: ['websocket', 'polling'],
      upgrade: true,
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 20000,
      autoConnect: true,
      path: '/socket.io/',
      withCredentials: false
    });

    // Initialize DOM elements
    const textInput = document.getElementById('text-input');
    const roomIdElement = document.getElementById('room-id');
    const userCountSpan = document.querySelector('#user-count span');
    const loadingOverlay = document.getElementById('loading-overlay');
    const copyButton = document.getElementById('copy-button');
    const connectionStatus = document.getElementById('connection-status');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const messagesContainer = document.getElementById('messages-container');
    const chatToggle = document.getElementById('chat-toggle');
    const chatSection = document.getElementById('chat-section');
    const nicknameButton = document.getElementById('nickname-button');
    const nicknameModal = document.getElementById('nickname-modal');
    const nicknameForm = document.getElementById('nickname-form');
    const nicknameInput = document.getElementById('nickname-input');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const filesContainer = document.getElementById('files-container');

    // Get room ID and username from URL
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');
    let currentUsername = urlParams.get('username') ? decodeURIComponent(urlParams.get('username')) : '';

    if (!roomId) {
      showNotification('No room ID provided!', 'error');
      setTimeout(() => window.location.href = '/', 2000);
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => {
        notification.className = 'notification';
      }, 3000);
    }

    // Nickname modal functions
    function showNicknameModal() {
      nicknameModal.classList.add('show');
      nicknameInput.value = currentUsername;
      nicknameInput.focus();
    }

    function hideNicknameModal() {
      nicknameModal.classList.remove('show');
    }

    // Chat functions
    function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      const messageData = {
        text: message,
        timestamp: Date.now()
      };

      socket.emit('chat-message', messageData, (response) => {
        if (response?.error) {
          showNotification(response.error, 'error');
        } else {
          chatInput.value = '';
          chatInput.style.height = 'auto';
          sendButton.disabled = true;
        }
      });
    }

    function addMessageToChat(messageData, isSent = false) {
      const messageElement = document.createElement('div');
      
      if (messageData.username === 'System') {
        messageElement.className = 'message system';
        messageElement.innerHTML = `<div class="text">${messageData.text}</div>`;
      } else {
        messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
        const username = isSent ? 'You' : messageData.username || 'Unknown User';
        messageElement.innerHTML = `
          <div class="username">${username}</div>
          <div class="text">${messageData.text}</div>
        `;
      }
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Event Listeners
    // Nickname button and modal
    nicknameButton.addEventListener('click', showNicknameModal);
    nicknameModal.addEventListener('click', (e) => {
      if (e.target === nicknameModal) {
        hideNicknameModal();
      }
    });

    // Nickname form submission
    nicknameForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const newUsername = nicknameInput.value.trim();
      
      if (!newUsername) {
        showNotification('Please enter a username', 'error');
        return;
      }

      if (newUsername.length > 20) {
        showNotification('Username must be less than 20 characters', 'error');
        return;
      }

      if (newUsername !== currentUsername) {
        socket.emit('set-username', newUsername, (response) => {
          if (response?.error) {
            showNotification(response.error, 'error');
          } else {
            currentUsername = newUsername;
            showNotification('Nickname updated successfully!');
            hideNicknameModal();
          }
        });
      } else {
        hideNicknameModal();
      }
    });

    // Chat toggle
    chatToggle.addEventListener('click', () => {
      chatSection.classList.toggle('hidden');
      if (!chatSection.classList.contains('hidden')) {
        unreadMessageCount = 0;
        badge.textContent = '0';
        badge.classList.remove('show');
      }
    });

    // Chat input
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (Math.min(this.scrollHeight, 120)) + 'px';
      sendButton.disabled = !this.value.trim();
    });

    // Send message
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // File upload
    uploadBtn.addEventListener('click', () => {
      fileInput.click();
    });

    // Socket event handlers
    socket.on('connect', () => {
      console.log('Connected to server with ID:', socket.id);
      connectionStatus.textContent = 'Connected';
      connectionStatus.className = 'connected show';
      connectionStatus.style.display = 'block';
      
      if (roomId) {
        joinRoom();
      }
      
      setTimeout(() => {
        connectionStatus.className = 'connected';
        setTimeout(() => {
          connectionStatus.style.display = 'none';
        }, 300);
      }, 2000);
    });

    let unreadMessageCount = 0;
    const badge = document.createElement('div');
    badge.className = 'badge';
    chatToggle.appendChild(badge);

    socket.on('chat-message', (messageData) => {
      addMessageToChat(messageData);
      if (chatSection.classList.contains('hidden')) {
        unreadMessageCount++;
        badge.textContent = unreadMessageCount;
        badge.classList.add('show');
      }
    });

    socket.on('username-changed', (data) => {
      addMessageToChat({
        text: `${data.oldUsername} changed their name to ${data.newUsername}`,
        username: 'System',
        timestamp: Date.now()
      }, false);
    });

    // Initialize username if provided
    if (currentUsername) {
      socket.emit('set-username', currentUsername);
    }

    // Handle escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && nicknameModal.classList.contains('show')) {
        hideNicknameModal();
      }
    });

    // Join room function with retry logic
    function joinRoom(retryCount = 0) {
      if (!socket.connected) {
        console.log('Socket not connected, waiting to retry...');
        if (retryCount < 5) {
          setTimeout(() => joinRoom(retryCount + 1), 2000);
        } else {
          showNotification('Unable to connect to server after multiple attempts. Please refresh the page.', 'error');
        }
        return;
      }

      console.log('Joining room:', roomId);
    socket.emit('join-room', roomId, (response) => {
        console.log('Join room response:', response);
        if (response?.error) {
          if (response.error === 'Room not found') {
            // Create a new room instead of redirecting
            console.log('Room not found, creating new room...');
            socket.emit('create-room', (createResponse) => {
              console.log('Create room response:', createResponse);
              if (createResponse.error) {
                showNotification(createResponse.error, 'error');
                setTimeout(() => window.location.href = '/', 2000);
              } else {
                // Update URL with new room ID
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('room', createResponse.roomId);
                window.history.replaceState({}, '', newUrl);
                
                // Update room ID and enable inputs
                roomId = createResponse.roomId;
                roomIdElement.textContent = createResponse.roomId;
                textInput.value = createResponse.text || '';
                lastSuccessfulText = createResponse.text || '';
                textInput.disabled = false;
                copyButton.disabled = false;
                loadingOverlay.style.display = 'none';
                showNotification('Created and joined new room successfully!');

                // Load chat history if available
                if (createResponse.messages) {
                  createResponse.messages.forEach(message => {
                    addMessageToChat(message, message.username === 'You');
                  });
                  messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
              }
            });
          } else {
            showNotification(response.error, 'error');
            if (retryCount < 3) {
              setTimeout(() => joinRoom(retryCount + 1), 2000);
            } else {
              setTimeout(() => window.location.href = '/', 2000);
            }
          }
      } else {
        roomIdElement.textContent = roomId;
          if (response.text !== undefined) {
            textInput.value = response.text;
            lastSuccessfulText = response.text;
          }
          textInput.disabled = false;
          copyButton.disabled = false;
          loadingOverlay.style.display = 'none';
          showNotification('Connected to room successfully!');

          // Load chat history if available
          if (response.messages) {
            response.messages.forEach(message => {
              addMessageToChat(message, message.username === 'You');
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
      });
    }

    // Text synchronization with debounce and retry
    let updateTimeout;
    let lastSuccessfulText = '';

    textInput.addEventListener('input', () => {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        if (!socket.connected) {
          showNotification('Not connected to server', 'error');
          return;
        }
        
        const currentText = textInput.value;
        socket.emit('sync-text', currentText, (response) => {
          if (response?.error) {
            showNotification(response.error, 'error');
            // Revert to last successful text if needed
            if (lastSuccessfulText !== currentText) {
              textInput.value = lastSuccessfulText;
            }
          } else {
            lastSuccessfulText = currentText;
          }
        });
      }, 100);
    });

    socket.on('text-update', (text) => {
      if (text !== undefined && textInput.value !== text) {
        const start = textInput.selectionStart;
        const end = textInput.selectionEnd;
        textInput.value = text;
        lastSuccessfulText = text;
        textInput.setSelectionRange(start, end);
      }
    });

    // User count and list updates
    socket.on('user-count', (count) => {
      if (typeof count === 'number') {
        userCountSpan.textContent = count;
      }
    });

    socket.on('user-list', (users) => {
      console.log('Received user list update:', users);
      updateUserList(users);
    });

    // Function to update user list
    function updateUserList(users) {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.className = 'user-item';
        li.textContent = user.name;
        userList.appendChild(li);
      });
    }

    // Copy room link with error handling and fallback
    function copyRoomLink() {
      if (!roomId) {
        showNotification('No room ID available', 'error');
        return;
      }

      const roomLink = `${window.location.origin}/app.html?room=${encodeURIComponent(roomId)}`;
      
      // Try using the Clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(roomLink)
          .then(() => {
            showNotification('Room link copied to clipboard!');
            copyButton.classList.add('copied');
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
              copyButton.classList.remove('copied');
              copyButton.textContent = 'Copy Room Link';
            }, 2000);
          })
          .catch((error) => {
            console.error('Failed to copy:', error);
            fallbackCopyToClipboard(roomLink);
          });
      } else {
        // Fallback for non-HTTPS or older browsers
        fallbackCopyToClipboard(roomLink);
      }
    }

    // Fallback copy to clipboard method
    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showNotification('Room link copied to clipboard!');
        copyButton.classList.add('copied');
        copyButton.textContent = 'Copied!';
        setTimeout(() => {
          copyButton.classList.remove('copied');
          copyButton.textContent = 'Copy Room Link';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy:', error);
        showNotification('Failed to copy link. Please copy manually.', 'error');
      }
      
      document.body.removeChild(textArea);
    }

    // Initial connection status
    connectionStatus.textContent = 'Connecting to server...';
    connectionStatus.className = 'disconnected show';
    connectionStatus.style.display = 'block';
    textInput.disabled = true;
    copyButton.disabled = true;

    // Add touch-specific improvements
    textInput.addEventListener('touchstart', () => {
      // Prevent zoom on double tap
      textInput.style.fontSize = '16px';
    });

    textInput.addEventListener('touchend', () => {
      // Reset font size after touch
      setTimeout(() => {
        textInput.style.fontSize = '';
      }, 100);
    });

    // Prevent scrolling when touching buttons
    document.querySelectorAll('button').forEach(button => {
      button.addEventListener('touchstart', (e) => {
        e.preventDefault();
      }, { passive: false });
    });

    // Handle orientation change
    window.addEventListener('orientationchange', () => {
      // Recalculate textarea height
      setTimeout(() => {
        textInput.style.height = 'auto';
        textInput.style.height = textInput.scrollHeight + 'px';
      }, 100);
    });

    // Handle file upload
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Check file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        showNotification('File size must be less than 5MB', 'error');
        fileInput.value = '';
        return;
      }

      // Check file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain'];
      if (!allowedTypes.includes(file.type)) {
        showNotification('Only JPEG, PNG, GIF, PDF, and TXT files are allowed', 'error');
        fileInput.value = '';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          // Share file info with other users in the room
          socket.emit('file-share', {
            filename: result.filename,
            originalname: result.originalname,
            size: result.size,
            mimetype: result.mimetype
          }, (response) => {
            if (response.error) {
              showNotification(response.error, 'error');
            } else {
              showNotification('File uploaded successfully!');
            }
          });
        } else {
          showNotification(result.error || 'Failed to upload file', 'error');
        }
      } catch (error) {
        console.error('Upload error:', error);
        showNotification('Failed to upload file. Please try again.', 'error');
      } finally {
        // Reset button state
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload File';
        // Reset file input
        fileInput.value = '';
      }
    });

    // Handle received files
    socket.on('file-received', (fileInfo) => {
      addFileToList(fileInfo);
    });

    // Add file to the list
    function addFileToList(fileInfo) {
      const fileList = document.getElementById('file-list');
      fileList.classList.add('visible');
      
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      
      const icon = getFileIcon(fileInfo.mimetype);
      const size = formatFileSize(fileInfo.size);
      
      fileItem.innerHTML = `
        <span class="file-icon">${icon}</span>
        <div class="file-info">
          <div class="file-name">${fileInfo.originalname}</div>
          <div class="file-size">${size}</div>
        </div>
        <a href="/uploads/${fileInfo.filename}" class="file-download" download>
          Download
        </a>
      `;
      
      filesContainer.insertBefore(fileItem, filesContainer.firstChild);
    }

    // Get appropriate icon for file type
    function getFileIcon(mimetype) {
      const icons = {
        'image/jpeg': 'ðŸ–¼ï¸',
        'image/png': 'ðŸ–¼ï¸',
        'image/gif': 'ðŸ–¼ï¸',
        'application/pdf': 'ðŸ“„',
        'text/plain': 'ðŸ“'
      };
      return icons[mimetype] || 'ðŸ“Ž';
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Function to show join/leave notification
    function showJoinNotification(data) {
      const notification = document.getElementById('join-notification');
      const message = data.username ? `${data.username} joined the room` : 'A user joined the room';
      notification.textContent = message;
      notification.className = `join-notification join show`;
      setTimeout(() => {
        notification.className = 'join-notification';
      }, 3000);
    }

    // Listen for user join/leave events
    socket.on('user-joined', (data) => {
      showJoinNotification(data);
    });

    socket.on('user-left', (data) => {
      const notification = document.getElementById('join-notification');
      const message = data.username ? `${data.username} left the room` : 'A user left the room';
      notification.textContent = message;
      notification.className = `join-notification leave show`;
      setTimeout(() => {
        notification.className = 'join-notification';
      }, 3000);
    });

    // Add touch-specific improvements
    document.addEventListener('DOMContentLoaded', () => {
      // Prevent default touch behavior for buttons
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('touchstart', (e) => {
          e.preventDefault();
          // Add active state
          button.style.opacity = '0.7';
        }, { passive: false });

        button.addEventListener('touchend', (e) => {
          e.preventDefault();
          // Remove active state
          button.style.opacity = '1';
          // Trigger click
          button.click();
        }, { passive: false });

        button.addEventListener('touchcancel', () => {
          // Remove active state if touch is cancelled
          button.style.opacity = '1';
        }, { passive: false });
      });

      // Improve file input touch handling
      const fileInput = document.getElementById('file-input');
      const uploadBtn = document.getElementById('upload-btn');

      uploadBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        uploadBtn.style.opacity = '0.7';
      }, { passive: false });

      uploadBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        uploadBtn.style.opacity = '1';
        fileInput.click();
      }, { passive: false });

      uploadBtn.addEventListener('touchcancel', () => {
        uploadBtn.style.opacity = '1';
      }, { passive: false });
    });
  </script>
</body>
</html>